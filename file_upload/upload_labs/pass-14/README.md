# Pass-14 getimagesize() Bypass

## 0x00 Lab Overview 

This lab is maily about to bypass file type check by image web shell (.jpg, .png, .gif).

## 0x01 Source Code

```php
function isImage($filename){
    $types = '.jpeg|.png|.gif';
    if(file_exists($filename)){
        $info = getimagesize($filename);
        $ext = image_type_to_extension($info[2]);
        if(stripos($types,$ext)){
            return $ext;
        }else{
            return false;
        }
    }else{
        return false;
    }
}

$is_upload = false;
$msg = null;
if(isset($_POST['submit'])){
    $temp_file = $_FILES['upload_file']['tmp_name'];
    $res = isImage($temp_file);
    if(!$res){
        $msg = "文件未知，上传失败！";
    }else{
        $img_path = $UPLOAD_ADDR."/".rand(10, 99).date("YmdHis").$res;
        if(move_uploaded_file($temp_file,$img_path)){
            $is_upload = true;
        }
        else{
            $msg = "上传失败";
        }
    }
}
```

## 0x02 Go Hack It

### Prepare a Webshell

Follow the instruction [here](../../image_webshell).

And click the [gen_imghshell.bat](./gen_imghshell.bat) to create all three type of image shell.

### jpg.php

![](./jpg.php)

### png.php

![](./png.php)

### gif.php

![](./gif.php)

Check the results here. And these image shell need to work with php include.

![](./imgs/upload.jpg)
