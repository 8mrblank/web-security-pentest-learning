# Pass-13 Image Web Shell Bypass

## 0x00 Lab Overview 

This lab is maily about to bypass file prefix check by image web shell (.jpg, .png, .gif).

## 0x01 Source Code

```php
function getReailFileType($filename){
    $file = fopen($filename, "rb");
    $bin = fread($file, 2); //只读2字节
    fclose($file);
    $strInfo = @unpack("C2chars", $bin);    
    $typeCode = intval($strInfo['chars1'].$strInfo['chars2']);    
    $fileType = '';    
    switch($typeCode){      
        case 255216:            
            $fileType = 'jpg';
            break;
        case 13780:            
            $fileType = 'png';
            break;        
        case 7173:            
            $fileType = 'gif';
            break;
        default:            
            $fileType = 'unknown';
        }    
        return $fileType;
}

$is_upload = false;
$msg = null;
if(isset($_POST['submit'])){
    $temp_file = $_FILES['upload_file']['tmp_name'];
    $file_type = getReailFileType($temp_file);

    if($file_type == 'unknown'){
        $msg = "文件未知，上传失败！";
    }else{
        $img_path = $UPLOAD_ADDR."/".rand(10, 99).date("YmdHis").".".$file_type;
        if(move_uploaded_file($temp_file,$img_path)){
            $is_upload = true;
        }
        else{
            $msg = "上传失败";
        }
    }
}
```

## 0x02 Go Hack It

### Prepare a Webshell

Follow the instruction [here](../../image_webshell).

And click the [gen_imghshell.bat](./gen_imghshell.bat) to create all three type of image shell.

### jpg.php

![](./jpg.php)

### png.php

![](./png.php)

### gif.php

![](./gif.php)

Check the results here. And these image shell need to work with php include.

![](./imgs/upload.jpg)

